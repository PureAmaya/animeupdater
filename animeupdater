#!/bin/bash
#=======================================================================
# animeupdater v1.0 - å¯å®‰è£…ã€å¯é…ç½®çš„ Docker Compose é¡¹ç›®ç®¡ç†å·¥å…·
#=======================================================================

# --- é™æ€é…ç½® ---
CONFIG_DIR="$HOME/.config/animeupdater"
CONFIG_FILE="$CONFIG_DIR/config"


# --- ä¾èµ–å®‰è£…åŠŸèƒ½ ---
install_dependencies() {
    echo "ğŸ” æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒå’Œä¾èµ–..."

    # 1. ç¡¬æ€§æ£€æŸ¥ï¼šDocker
    if ! command -v docker &> /dev/null; then
        echo "âŒ é”™è¯¯ï¼šDocker æœªå®‰è£…ï¼è¯·å…ˆæ‰‹åŠ¨å®‰è£…ã€‚"; exit 1;
    else
        echo "   âœ… Docker Engine å·²æ‰¾åˆ°ã€‚"
    fi
    if ! docker info &> /dev/null; then
        echo "   âš ï¸ è­¦å‘Šï¼šDocker å®ˆæŠ¤è¿›ç¨‹ (daemon) ä¼¼ä¹æœªåœ¨è¿è¡Œã€‚è¯·ç¡®ä¿å…¶å·²å¯åŠ¨ã€‚"
    fi

    # 2. æ£€æŸ¥å¹¶å®‰è£… yq (åŒé‡ç­–ç•¥)
    if ! command -v yq &> /dev/null; then
        echo "   -> 'yq' æœªæ‰¾åˆ°ï¼Œå¼€å§‹å°è¯•å®‰è£…..."
        local installed_by_pm=false
        if command -v brew &> /dev/null; then
            brew install yq && installed_by_pm=true
        elif command -v apt-get &> /dev/null; then
            apt-get update && apt-get install -y yq && installed_by_pm=true
        elif command -v dnf &> /dev/null; then
            dnf install -y yq && installed_by_pm=true
        elif command -v yum &> /dev/null; then
            yum install -y yq && installed_by_pm=true
        elif command -v pacman &> /dev/null; then
            pacman -S --noconfirm yq && installed_by_pm=true
        fi

        # å¦‚æœç­–ç•¥ä¸€å¤±è´¥ï¼Œå°è¯•äºŒè¿›åˆ¶ä¸‹è½½
        if [ "$installed_by_pm" = false ] && ! command -v yq &> /dev/null; then
            echo "   -> åŒ…ç®¡ç†å™¨å®‰è£…å¤±è´¥æˆ–è·³è¿‡ï¼Œå°è¯•å®˜æ–¹äºŒè¿›åˆ¶ä¸‹è½½..."

            if ! command -v wget &> /dev/null && ! command -v curl &> /dev/null; then
                echo "      âŒ é”™è¯¯: 'wget' æˆ– 'curl' å‘½ä»¤æœªæ‰¾åˆ°ï¼Œæ— æ³•æ‰§è¡Œå¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆã€‚"
                exit 1
            fi

            local os=$(uname -s | tr '[:upper:]' '[:lower:]')
            local arch=$(uname -m)
            case "$arch" in
                x86_64) arch="amd64" ;;
                aarch64 | arm64) arch="arm64" ;;
                *) echo "      âŒ é”™è¯¯: ä¸æ”¯æŒçš„å¤„ç†å™¨æ¶æ„ '$arch'ã€‚è¯·æ‰‹åŠ¨å®‰è£… yqã€‚"; exit 1 ;;
            esac
            
            local yq_url="https://github.com/mikefarah/yq/releases/latest/download/yq_${os}_${arch}"
            local yq_dest="/usr/local/bin/yq"
            echo "         -> æ­£åœ¨ä» $yq_url ä¸‹è½½..."

            if command -v wget &> /dev/null; then
                wget -q "$yq_url" -O "$yq_dest"
            else
                curl -sL "$yq_url" -o "$yq_dest"
            fi

            if [ $? -eq 0 ]; then
                chmod +x "$yq_dest"
            else
                echo "      âŒ 'yq' äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–æ‰‹åŠ¨å®‰è£…ã€‚"
                rm -f "$yq_dest"
            fi
        fi
    fi

    # æœ€ç»ˆéªŒè¯ yq
    if ! command -v yq &> /dev/null; then
        echo "âŒ é”™è¯¯ï¼šæ‰€æœ‰å®‰è£… 'yq' çš„å°è¯•å‡å·²å¤±è´¥ã€‚è¯·æ‰‹åŠ¨å®‰è£…åé‡è¯•ã€‚"
        exit 1
    else
        echo "   âœ… 'yq' å·²æˆåŠŸå®‰è£…æˆ–ç¡®è®¤å­˜åœ¨ã€‚"
    fi
    
    # 3. æ£€æŸ¥ Docker Compose
    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        echo "   -> 'Docker Compose' æœªæ‰¾åˆ°ï¼Œæ­£åœ¨å°è¯•å®‰è£…..."
        if command -v apt-get &> /dev/null; then apt-get update && apt-get install -y docker-compose-plugin; fi
    fi
    echo "   âœ… 'Docker Compose' å·²å®‰è£…æˆ–ç¡®è®¤å­˜åœ¨ã€‚"
}


# --- å®‰è£…åŠŸèƒ½ ---
install_script() {
    echo "ğŸš€ å¼€å§‹å®‰è£… animeupdater v1.0..."
    if [ "$(id -u)" -ne 0 ]; then echo "âŒ é”™è¯¯: å®‰è£…éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚è¯·ä½¿ç”¨ 'sudo ./animeupdater install' è¿è¡Œã€‚"; exit 1; fi
    install_dependencies
    local project_dir
    while true; do
        read -p "è¯·è¾“å…¥æ‚¨çš„ Docker Compose é¡¹ç›®çš„ç»å¯¹è·¯å¾„: " project_dir
        local compose_path="$project_dir/docker-compose.yml"; local config_path="$project_dir/config/config.yaml"
        if [ ! -d "$project_dir" ]; then echo "âŒ é”™è¯¯: ç›®å½• '$project_dir' ä¸å­˜åœ¨ã€‚";
        elif [ ! -f "$compose_path" ]; then echo "âŒ é”™è¯¯: åœ¨è¯¥ç›®å½•ä¸‹æœªæ‰¾åˆ° 'docker-compose.yml' æ–‡ä»¶ã€‚";
        elif [ ! -f "$config_path" ]; then echo "âŒ é”™è¯¯: åœ¨è¯¥ç›®å½•ä¸‹æœªæ‰¾åˆ° 'config/config.yaml' æ–‡ä»¶ã€‚";
        else echo "âœ… è·¯å¾„å’Œé…ç½®æ–‡ä»¶å‡æœ‰æ•ˆ: $project_dir"; break; fi
        read -p "å®‰è£…å·²ä¸­æ­¢ã€‚æ˜¯å¦è¦å°è¯•å…¶ä»–è·¯å¾„? [y/N]: " retry
        if [[ ! "$retry" =~ ^[yY](es)?$ ]]; then echo "ğŸš« å®‰è£…å·²å–æ¶ˆã€‚"; exit 1; fi
    done
    echo "ğŸ“ æ­£åœ¨åˆ›å»ºè„šæœ¬é…ç½®æ–‡ä»¶..."; mkdir -p "$CONFIG_DIR"; echo "COMPOSE_PROJECT_DIR=\"$project_dir\"" > "$CONFIG_FILE"
    echo "ğŸŒ æ­£åœ¨å°†è„šæœ¬å®‰è£…åˆ° /usr/local/bin/ ..."; cp "$0" "/usr/local/bin/animeupdater"; chmod +x "/usr/local/bin/animeupdater"
    echo "ğŸ‰ å®‰è£…æˆåŠŸï¼ç°åœ¨æ‚¨å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ç›´æ¥è¿è¡Œ 'animeupdater' å‘½ä»¤äº†ã€‚"
    exit 0
}


# --- å¸è½½åŠŸèƒ½ ---
uninstall_script() {
    echo "ğŸ—‘ï¸ å¼€å§‹å¸è½½ animeupdater..."; if [ "$(id -u)" -ne 0 ]; then echo "âŒ é”™è¯¯: å¸è½½éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚"; exit 1; fi
    read -p "è¿™å°†åˆ é™¤ /usr/local/bin/animeupdater å’Œè„šæœ¬é…ç½®æ–‡ä»¶ã€‚æ‚¨ç¡®å®šå—? [y/N]: " confirm
    if [[ ! "$confirm" =~ ^[yY](es)?$ ]]; then echo "ğŸš« æ“ä½œå·²å–æ¶ˆã€‚"; exit 0; fi
    rm -f "/usr/local/bin/animeupdater"; rm -rf "$CONFIG_DIR"
    echo "âœ… animeupdater å·²æˆåŠŸå¸è½½ã€‚"
    exit 0
}


# --- äº¤äº’å¼æ¨¡å¼ä¸»ç¨‹åº ---
run_interactive_mode() {
    if [ ! -f "$CONFIG_FILE" ]; then echo "âŒ é”™è¯¯: animeupdater å°šæœªé…ç½®ã€‚"; exit 1; fi; source "$CONFIG_FILE"
    local yaml_file_to_modify="$COMPOSE_PROJECT_DIR/config/config.yaml"
    show_menu() { echo -e "========================================\n         animeupdater v1.0\n========================================\n é¡¹ç›®è·¯å¾„: $COMPOSE_PROJECT_DIR\n----------------------------------------\n  1. æ‰‹åŠ¨å…³é—­ Docker Compose æœåŠ¡\n  2. æ‰‹åŠ¨å¼€å¯ Docker Compose æœåŠ¡\n  3. æ›´æ–°æ‰€æœ‰ CRON å¹¶é‡å¯æœåŠ¡\n  4. æŸ¥çœ‹æœåŠ¡æ—¥å¿— (å®æ—¶)\n  5. è¿›å…¥é¡¹ç›®ç›®å½• (å¼€å¯æ–°Shell)\n  0. é€€å‡ºè„šæœ¬\n----------------------------------------"; }
    stop_docker() { echo "ğŸ›‘ æ­£åœ¨åœæ­¢..."; (cd "$COMPOSE_PROJECT_DIR" && docker-compose down); echo "âœ… å·²åœæ­¢ã€‚"; }
    start_docker() { echo "ğŸš€ æ­£åœ¨å¯åŠ¨..."; (cd "$COMPOSE_PROJECT_DIR" && docker-compose up -d); echo "âœ… å·²å¯åŠ¨ã€‚"; }
    view_logs() { echo "ğŸ“œ æŸ¥çœ‹æ—¥å¿— (æŒ‰ Ctrl+C é€€å‡º)..."; (cd "$COMPOSE_PROJECT_DIR" && docker-compose logs -f); }
    go_to_compose_dir() { echo "â¤µï¸ è¿›å…¥é¡¹ç›®ç›®å½• (è¾“å…¥ 'exit' è¿”å›)..."; (cd "$COMPOSE_PROJECT_DIR" && bash); }
    update_and_restart() { echo "ğŸ”„ å¼€å§‹æ‰§è¡Œâ€œæ›´æ–°å¹¶é‡å¯â€æµç¨‹..."; if [ ! -f "$yaml_file_to_modify" ]; then echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°ç”¨æˆ·é…ç½®æ–‡ä»¶: $yaml_file_to_modify"; return 1; fi; stop_docker; echo "â° æ­£åœ¨è®¡ç®—æ–°çš„ CRON æ—¶é—´ (å½“å‰æ—¶é—´ + 2 åˆ†é’Ÿ)..."; local new_minute=$(date -d "+2 minutes" +%M); local new_hour=$(date -d "+2 minutes" +%H); local new_cron_string="$new_minute $new_hour * * *"; echo "   æ–°çš„ CRON è®¡åˆ’å°†ç»Ÿä¸€è®¾ç½®ä¸º: '$new_cron_string'"; echo "ğŸ“ æ­£åœ¨æ›´æ–° YAML æ–‡ä»¶ä¸­çš„æ‰€æœ‰ CRON..."; yq e -i "(.Alist2StrmList[].cron) |= \"$new_cron_string\"" "$yaml_file_to_modify"; echo "   YAML æ–‡ä»¶æ›´æ–°æˆåŠŸï¼"; start_docker; echo "ğŸ‰ æµç¨‹æ‰§è¡Œå®Œæ¯•ï¼"; }
    while true; do show_menu; read -p "è¯·è¾“å…¥é€‰é¡¹ [0-5]: " choice; case $choice in 1) stop_docker ;; 2) start_docker ;; 3) update_and_restart ;; 4) view_logs ;; 5) go_to_compose_dir ;; 0) echo "ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼"; exit 0 ;; *) echo "âŒ æ— æ•ˆè¾“å…¥ã€‚" ;; esac; echo; read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."; echo; echo; done
}


# --- è„šæœ¬ä¸»å…¥å£ ---
case "$1" in
    install) install_script ;;
    uninstall) uninstall_script ;;
    "" | -h | --help) if [ -t 1 ] && [ "$1" == "" ]; then run_interactive_mode; else echo -e "ç”¨æ³•: \n  sudo ./animeupdater install      # å®‰è£…ã€æ£€æŸ¥ä¾èµ–å¹¶é…ç½®è„šæœ¬\n  sudo animeupdater uninstall    # å¸è½½è„šæœ¬\n  animeupdater                 # è¿›å…¥äº¤äº’å¼ç®¡ç†èœå•"; fi ;;
    *) echo "âŒ æœªçŸ¥æŒ‡ä»¤: '$1'"; echo "   å¯ç”¨æŒ‡ä»¤: install, uninstall"; exit 1 ;;
esac
